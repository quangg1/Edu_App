import os, json, nest_asyncio, threading, tempfile
from fastapi import FastAPI, UploadFile, Form, Request, HTTPException,Body,File
from fastapi.responses import JSONResponse
from fastapi.middleware import cors
from pydantic import BaseModel, HttpUrl,ConfigDict, Field
from pydantic.alias_generators import to_camel
from typing import Optional, List
import uvicorn
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request as GoogleAuthRequest
from googleapiclient.discovery import build
from docx import Document
import pdfplumber
import google.generativeai as genai
import logging
import json, traceback
import tempfile, os, json, time, re


# --- Basic Configuration ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- Environment Variables ---
os.environ["GOOGLE_API_KEY"] = "AIzaSyC4bqUsDLNgFwaMBLgKZcQjabNUSYuQCkg"      # <- Your Gemini key here
os.environ["NGROK_AUTHTOKEN"] = "31cnLAvDp9EM0NXsWN3Pnnpi0Nv_42XHcfVwgdG3DKQsHAiPs" # <- Your Ngrok token here

# ----------------------------
# Pydantic Models for API Response Structure
# ----------------------------
class GoogleFormResponse(BaseModel):
    success: bool
    form_url: Optional[HttpUrl] = None
    form_id: Optional[str] = None
    error: Optional[str] = None

    # ThÃªm cáº¥u hÃ¬nh nÃ y vÃ o
    model_config = ConfigDict(
        alias_generator=to_camel,
        populate_by_name=True, # Cho phÃ©p model hoáº¡t Ä‘á»™ng tá»‘t vá»›i cáº£ 2 kiá»ƒu
    )
# ----------------------------
# Configure Gemini + FastAPI + Google Forms
# ----------------------------
genai.configure(api_key=os.environ.get("GOOGLE_API_KEY"))
app = FastAPI()

# OAuth 2.0 configuration
SCOPES = ['https://www.googleapis.com/auth/forms']
creds = None

def get_google_credentials():
    global creds
    if os.path.exists('token.json'):
        creds = Credentials.from_authorized_user_file('token.json', SCOPES)
    
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(GoogleAuthRequest()) # Use aliased import to avoid conflict with FastAPI's Request
        else:
            flow = InstalledAppFlow.from_client_secrets_file(
                'credentials.json', SCOPES)
            # NOTE: For a real web app, flow.run_local_server is not ideal.
            # You should handle the redirect flow manually.
            # This redirect_uri must be registered in your Google Cloud Console credentials.
            flow.redirect_uri = "https://gemini.veronlabs.com/bot4/oauth2callback"
            creds = flow.authorize_url(port=8004)
        
        with open('token.json', 'w') as token:
            token.write(creds.to_json())
    
    return creds

# Add OAuth callback endpoint (This is for the command-line flow, might need adjustments for a web server)
@app.get("/oauth2callback")
async def oauth2callback(request: Request):
    # This endpoint is more complex to implement correctly in a production server.
    # The run_local_server method handles this for you in a local context.
    # For now, we can assume token.json is generated locally first.
    return {"message": "OAuth flow callback received. Check server logs."}


# âœ… Enable CORS
app.add_middleware(
    cors.CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ----------------------------
# âœ… SINGLE, CORRECTED Endpoint for Creating Google Forms
# ----------------------------
@app.post("/create_google_form", response_model=GoogleFormResponse)
async def create_google_form(request: Request):
    try:
        data = await request.json()
        logger.info(f"Received data for form creation")
        
        if not isinstance(data, dict) or 'questions' not in data or not data['questions']:
            raise HTTPException(status_code=400, detail="Invalid request format: 'questions' array is missing or empty.")
            
        questions = data['questions']
        
        # Get credentials
        creds = get_google_credentials()
        logger.info("Google credentials obtained successfully.")
        
        # Build the Google Forms service
        form_service = build('forms', 'v1', credentials=creds)
        
        # Create the initial form structure
        new_form = {
            'info': {
                'title': 'Multiple Choice Quiz (Generated by AI)',
                'documentTitle': 'Multiple Choice Quiz',
                'description': 'This quiz was automatically generated based on your document.'
            }
        }
        
        created_form = form_service.forms().create(body=new_form).execute()
        form_id = created_form['formId']
        
        # Prepare batch update requests for all questions
        update_requests = []
        for idx, q in enumerate(questions):
            question_text = q.get('question', f'Question {idx+1}')
            options = q.get('options', {})
            
            # Ensure all options are strings
            form_options = [
                {'value': str(options.get('A', ''))},
                {'value': str(options.get('B', ''))},
                {'value': str(options.get('C', ''))},
                {'value': str(options.get('D', ''))}
            ]
            
            update_requests.append({
                'createItem': {
                    'item': {
                        'title': question_text,
                        'questionItem': {
                            'question': {
                                'required': True,
                                'choiceQuestion': {
                                    'type': 'RADIO',
                                    'options': form_options,
                                    'shuffle': False
                                }
                            }
                        }
                    },
                    'location': {'index': idx}
                }
            })
            
        if not update_requests:
            return GoogleFormResponse(success=False, error="No valid questions were processed to add to the form.")

        # Execute the batch update to add all questions at once
        form_service.forms().batchUpdate(
            formId=form_id, 
            body={'requests': update_requests}
        ).execute()
        
        form_url = f'https://docs.google.com/forms/d/{form_id}/edit'
        logger.info(f"Form created successfully: {form_url}")
        
        return GoogleFormResponse(
            success=True,
            form_url=form_url,
            form_id=form_id
        )
        
    except Exception as e:
        logger.error(f"An error occurred while creating the Google Form: {e}", exc_info=True)
        # Return a JSON response using the Pydantic model for consistency
        return GoogleFormResponse(success=False, error=str(e))

# ----------------------------
# âœ… Utility: Extract text
# ----------------------------
def extract_text_from_pdf(file_path):
    """
    TrÃ­ch xuáº¥t vÄƒn báº£n tá»« file PDF báº±ng pdfplumber Ä‘á»ƒ cÃ³ káº¿t quáº£ tá»‘t hÆ¡n.
    """
    text = ""
    try:
        with pdfplumber.open(file_path) as pdf:
            for page in pdf.pages:
                page_text = page.extract_text()
                if page_text:
                    text += page_text + "\n"
        # Náº¿u khÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c gÃ¬, cÃ³ thá»ƒ file lÃ  áº£nh scan
        if not text.strip():
            return "KhÃ´ng thá»ƒ trÃ­ch xuáº¥t vÄƒn báº£n tá»« file PDF nÃ y. File cÃ³ thá»ƒ lÃ  má»™t hÃ¬nh áº£nh Ä‘Æ°á»£c scan."
        return text
    except Exception as e:
        logger.error(f"Lá»—i khi xá»­ lÃ½ file PDF: {e}")
        # Tráº£ vá» má»™t thÃ´ng bÃ¡o lá»—i rÃµ rÃ ng
        return "TÃ i liá»‡u PDF bá»‹ lá»—i hoáº·c khÃ´ng thá»ƒ Ä‘á»c Ä‘Æ°á»£c."

def extract_text_from_docx(file_path):
    doc = Document(file_path)
    return "\n".join([para.text for para in doc.paragraphs])

# ----------------------------
# âœ… Generate MCQs with Gemini (TIáº¾NG VIá»†T)
# ----------------------------
def generate_mcqs(text, num_questions, subject=None, grade=None, topic=None):
    model = genai.GenerativeModel("gemini-2.5-flash")

    context_info = ""
    if subject:
        context_info += f"MÃ´n há»c: {subject}\n"
    if grade:
        context_info += f"Cáº¥p há»c/lá»›p: {grade}\n"
    if topic:
        context_info += f"Chá»§ Ä‘á»: {topic}\n"

    prompt = f"""
    Báº¡n lÃ  má»™t chuyÃªn gia giÃ¡o dá»¥c cÃ³ kinh nghiá»‡m trong viá»‡c biÃªn soáº¡n Ä‘á» thi.
    {context_info}
    Dá»±a trÃªn ná»™i dung tÃ i liá»‡u, hÃ£y táº¡o {num_questions} cÃ¢u há»i tráº¯c nghiá»‡m theo yÃªu cáº§u sau:

    1. PhÃ¢n loáº¡i cÃ¢u há»i theo Bloom's Taxonomy:
        - Remember (Nhá»›): 30%
        - Understand (Hiá»ƒu): 30%
        - Apply (Ãp dá»¥ng): 20%
        - Analyze (PhÃ¢n tÃ­ch): 10%
        - Evaluate (ÄÃ¡nh giÃ¡): 10%

    2. Má»—i cÃ¢u há»i cáº§n cÃ³:
        - CÃ¢u há»i rÃµ rÃ ng, sÃºc tÃ­ch
        - 4 phÆ°Æ¡ng Ã¡n (A,B,C,D) cÃ³ Ä‘á»™ phÃ¢n biá»‡t cao
        - ÄÃ¡p Ã¡n Ä‘Ãºng vÃ  giáº£i thÃ­ch chi tiáº¿t
        - Tá»« khÃ³a chÃ­nh vÃ  chá»§ Ä‘á» liÃªn quan
        - Äá»™ khÃ³ (1-5)

    3. YÃŠU Cáº¦U QUAN TRá»ŒNG NHáº¤T: Pháº£n há»“i CHá»ˆ Ä‘Æ°á»£c chá»©a má»™t Ä‘á»‘i tÆ°á»£ng JSON há»£p lá»‡.
       KHÃ”NG thÃªm báº¥t ká»³ vÄƒn báº£n nÃ o trÆ°á»›c hoáº·c sau Ä‘á»‘i tÆ°á»£ng JSON. KHÃ”NG sá»­ dá»¥ng Markdown code fences (```json).
    
    Format JSON:
    {{
        "questions": [
            {{
                "id": 1,
                "question": "CÃ¢u há»i...",
                "options": {{
                    "A": "...",
                    "B": "...",
                    "C": "...",
                    "D": "..."
                }},
                "correct_answer": "A",
                "explanation": "...",
                "difficulty": 3,
                "taxonomy": "remember",
                "keywords": ["..."],
                "topic": "..."
            }}
        ],
        "study_suggestions": ["..."],
        "references": ["..."],
        "search_terms": ["..."]
    }}
    """

    # GhÃ©p ná»™i dung vÄƒn báº£n
    full_prompt = prompt + f"\n\nNá»™i dung tÃ i liá»‡u:\n{text[:10000]}"

    try:
        response = model.generate_content(full_prompt)
        raw_text = response.text.strip()
        start_index = raw_text.find('{')
        end_index = raw_text.rfind('}') + 1

        if start_index == -1 or end_index == 0:
            return {"error": "Model did not return a valid JSON object.", "raw_output": raw_text}

        json_text = raw_text[start_index:end_index]
        mcqs = json.loads(json_text)
        return mcqs

    except Exception as e:
        logger.error(f"Error generating MCQs or parsing JSON: {e}")
        return {"error": f"Model did not return valid JSON ({e})", "raw_output": getattr(response, 'text', 'No response text.')}
def generate_lesson_plan(text, subject, grade, num_periods):
    model = genai.GenerativeModel("gemini-2.5-flash")

    prompt = f"""
Báº¡n lÃ  má»™t chuyÃªn gia giÃ¡o dá»¥c phá»• thÃ´ng giÃ u kinh nghiá»‡m, chuyÃªn thiáº¿t káº¿ giÃ¡o Ã¡n theo cÃ´ng vÄƒn 5512 (trÆ°á»›c Ä‘Ã¢y lÃ  CV513/SGDÄT-GDMNPT) cá»§a Bá»™ GD&ÄT Viá»‡t Nam.

Dá»±a vÃ o **Ná»˜I DUNG BÃ€I Há»ŒC** Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i Ä‘Ã¢y, hÃ£y táº¡o má»™t **Káº¾ HOáº CH BÃ€I Dáº Y (GIÃO ÃN)** hoÃ n chá»‰nh, chi tiáº¿t vÃ  chuyÃªn nghiá»‡p,
phÃ¹ há»£p vá»›i cáº¥p há»c tÆ°Æ¡ng á»©ng:
- Náº¿u lá»›p tá»« **6 Ä‘áº¿n 9** â†’ soáº¡n theo phong cÃ¡ch vÃ  ngÃ´n ngá»¯ cá»§a **báº­c Trung há»c CÆ¡ sá»Ÿ (THCS)**.
- Náº¿u lá»›p tá»« **10 Ä‘áº¿n 12** â†’ soáº¡n theo phong cÃ¡ch vÃ  yÃªu cáº§u nÄƒng lá»±c cá»§a **báº­c Trung há»c Phá»• thÃ´ng (THPT)**.

---

**YÃŠU Cáº¦U QUAN TRá»ŒNG:**
1. **Chá»‰ tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng JSON há»£p lá»‡.** KhÃ´ng bao gá»“m báº¥t ká»³ vÄƒn báº£n nÃ o khÃ¡c, lá»i giáº£i thÃ­ch hay kÃ½ tá»± ```json.
2. Suy luáº­n **TÃªn bÃ i dáº¡y** má»™t cÃ¡ch há»£p lÃ½ tá»« ná»™i dung Ä‘Æ°á»£c cung cáº¥p.
3. CÃ¡c má»¥c tiÃªu, há»c liá»‡u, vÃ  phÆ°Æ¡ng phÃ¡p Ä‘Ã¡nh giÃ¡ pháº£i Ä‘Æ°á»£c trÃ¬nh bÃ y dÆ°á»›i dáº¡ng má»™t **máº£ng cÃ¡c chuá»—i** (array of strings), trong Ä‘Ã³ má»—i chuá»—i tÆ°Æ¡ng á»©ng vá»›i má»™t gáº¡ch Ä‘áº§u dÃ²ng.
4. Äiá»n thÃ´ng tin cho **TRÆ¯á»œNG**, **Tá»”**, vÃ  **Há»Œ TÃŠN GIÃO VIÃŠN** báº±ng cÃ¡c giÃ¡ trá»‹ máº«u hoáº·c giá»¯ trá»‘ng náº¿u chÆ°a cÃ³.

---

**THÃ”NG TIN Äáº¦U VÃ€O**

* **MÃ´n há»c / Hoáº¡t Ä‘á»™ng giÃ¡o dá»¥c:** {subject}
* **Lá»›p:** {grade}
* **Thá»i gian thá»±c hiá»‡n:** {num_periods} tiáº¿t
* **Ná»˜I DUNG BÃ€I Há»ŒC:**
    ```
    {text}
    ```

---

**Cáº¤U TRÃšC JSON Äáº¦U RA Báº®T BUá»˜C**

HÃ£y tuÃ¢n thá»§ nghiÃªm ngáº·t cáº¥u trÃºc JSON sau:

{{
    "lesson_plan": {{
        "header": {{
            "school": "TRÆ¯á»œNG { 'THCS' if int(grade) <= 9 else 'THPT' } ABC",
            "department": "Tá»• { 'Khoa há»c xÃ£ há»™i' if subject.lower() in ['ngá»¯ vÄƒn','lá»‹ch sá»­','Ä‘á»‹a lÃ­','giÃ¡o dá»¥c cÃ´ng dÃ¢n'] else 'Khoa há»c tá»± nhiÃªn' }",
            "teacher_name": "(Há» vÃ  tÃªn giÃ¡o viÃªn)"
        }},
        "title": "(Tá»± suy luáº­n tá»« ná»™i dung)",
        "subject": "{subject}",
        "grade": "{grade}",
        "num_periods": {num_periods},
        "objectives": {{
            "knowledge": [
                "- (Ná»™i dung gáº¡ch Ä‘áº§u dÃ²ng 1)",
                "- (Ná»™i dung gáº¡ch Ä‘áº§u dÃ²ng 2)"
            ],
            "skills": [
                "- **NÄƒng lá»±c chung:** (VÃ­ dá»¥: Tá»± chá»§ vÃ  tá»± há»c, Giao tiáº¿p vÃ  há»£p tÃ¡c, Giáº£i quyáº¿t váº¥n Ä‘á»...)",
                "- **NÄƒng lá»±c Ä‘áº·c thÃ¹:** (VÃ­ dá»¥: NÄƒng lá»±c ngÃ´n ngá»¯, NÄƒng lá»±c khoa há»c, NÄƒng lá»±c tháº©m má»¹...)"
            ],
            "qualities": [
                "- (Pháº©m cháº¥t 1, vÃ­ dá»¥: YÃªu nÆ°á»›c)",
                "- (Pháº©m cháº¥t 2, vÃ­ dá»¥: ChÄƒm chá»‰, TrÃ¡ch nhiá»‡m)"
            ]
        }},
        "materials": [
            "- GiÃ¡o viÃªn: SÃ¡ch giÃ¡o khoa, mÃ¡y chiáº¿u, video clip X, phiáº¿u há»c táº­p sá»‘ 1.",
            "- Há»c sinh: SÃ¡ch giÃ¡o khoa, vá»Ÿ ghi, Ä‘á»“ dÃ¹ng há»c táº­p."
        ],
        "activities": [
            {{
                "name": "Hoáº¡t Ä‘á»™ng 1: Má»Ÿ Ä‘áº§u (XÃ¡c Ä‘á»‹nh váº¥n Ä‘á»)",
                "goal": "(Má»¥c tiÃªu cá»§a hoáº¡t Ä‘á»™ng nÃ y)",
                "steps": {{
                    "assign": "(BÆ°á»›c 1: Giao nhiá»‡m vá»¥ - ná»™i dung chi tiáº¿t)",
                    "perform": "(BÆ°á»›c 2: Thá»±c hiá»‡n nhiá»‡m vá»¥ - ná»™i dung chi tiáº¿t)",
                    "report": "(BÆ°á»›c 3: BÃ¡o cÃ¡o, tháº£o luáº­n - ná»™i dung chi tiáº¿t)",
                    "conclude": "(BÆ°á»›c 4: Káº¿t luáº­n, nháº­n Ä‘á»‹nh - ná»™i dung chi tiáº¿t)"
                }}
            }},
            {{
                "name": "Hoáº¡t Ä‘á»™ng 2: HÃ¬nh thÃ nh kiáº¿n thá»©c má»›i",
                "goal": "(Má»¥c tiÃªu cá»§a hoáº¡t Ä‘á»™ng nÃ y)",
                "steps": {{
                    "assign": "(Ná»™i dung chi tiáº¿t...)",
                    "perform": "(Ná»™i dung chi tiáº¿t...)",
                    "report": "(Ná»™i dung chi tiáº¿t...)",
                    "conclude": "(Ná»™i dung chi tiáº¿t...)"
                }}
            }},
            {{
                "name": "Hoáº¡t Ä‘á»™ng 3: Luyá»‡n táº­p",
                "goal": "(Má»¥c tiÃªu cá»§a hoáº¡t Ä‘á»™ng nÃ y)",
                "steps": {{
                    "assign": "(Ná»™i dung chi tiáº¿t...)",
                    "perform": "(Ná»™i dung chi tiáº¿t...)",
                    "report": "(Ná»™i dung chi tiáº¿t...)",
                    "conclude": "(Ná»™i dung chi tiáº¿t...)"
                }}
            }},
            {{
                "name": "Hoáº¡t Ä‘á»™ng 4: Váº­n dá»¥ng vÃ  má»Ÿ rá»™ng",
                "goal": "(Má»¥c tiÃªu cá»§a hoáº¡t Ä‘á»™ng nÃ y)",
                "steps": {{
                    "assign": "(Ná»™i dung chi tiáº¿t...)",
                    "perform": "(Ná»™i dung chi tiáº¿t...)",
                    "report": "(Ná»™i dung chi tiáº¿t...)",
                    "conclude": "(Ná»™i dung chi tiáº¿t...)"
                }}
            }}
        ],
        "assessment": [
            "- **HÃ¬nh thá»©c:** Quan sÃ¡t, váº¥n Ä‘Ã¡p, sáº£n pháº©m nhÃ³m, bÃ i viáº¿t ngáº¯n.",
            "- **CÃ´ng cá»¥:** Phiáº¿u há»c táº­p, cÃ¢u há»i tráº¯c nghiá»‡m, thang Ä‘o thÃ¡i Ä‘á»™.",
            "- **TiÃªu chÃ­:** (NÃªu rÃµ cÃ¡c tiÃªu chÃ­ Ä‘Ã¡nh giÃ¡ cho tá»«ng hoáº¡t Ä‘á»™ng hoáº·c sáº£n pháº©m)"
        ]
    }}
}}
"""

    try:
        response = model.generate_content(prompt)
        raw = response.text.strip()
        start = raw.find('{')
        end = raw.rfind('}') + 1
        json_text = raw[start:end]
        return json.loads(json_text)
    except Exception as e:
        return {"error": str(e), "raw_output": getattr(response, 'text', '')}

# ----------------------------
# âœ… FastAPI Endpoint for Generating MCQs
# ----------------------------
@app.post("/generate_mcqs")
async def generate_mcqs_endpoint(
    file: UploadFile = Form(...),
    num_questions: int = Form(...),
    subject: str = Form(None),
    grade: str = Form(None),
    topic: str = Form(None)
):
    # ðŸ• Báº¯t Ä‘áº§u Ä‘o thá»i gian xá»­ lÃ½
    start_time = time.time()

    with tempfile.NamedTemporaryFile(delete=False, suffix=file.filename) as temp_file:
        temp_path = temp_file.name
        content = await file.read()
        temp_file.write(content)

    try:
        # ðŸ§¾ Äá»c ná»™i dung file
        if file.filename.endswith(".pdf"):
            text = extract_text_from_pdf(temp_path)
        elif file.filename.endswith(".docx"):
            text = extract_text_from_docx(temp_path)
        else:
            raise HTTPException(status_code=400, detail="Unsupported file type. Please upload a PDF or DOCX file.")

        if not text.strip():
            raise HTTPException(status_code=400, detail="No text extracted from document.")

        # ðŸ¤– Gá»i model sinh cÃ¢u há»i
        mcq_result = generate_mcqs(text, num_questions=num_questions, subject=subject, grade=grade, topic=topic)


        end_time = time.time()
        response_payload = {
            "success": True,
            "provider": "Google Gemini",
            "model": "gemini-2.5-flash",
            "processing_time": round(end_time - start_time, 2),
            "subject": subject,
            "grade": grade,
            "topic": topic,
            "num_questions": num_questions,
            "questions": mcq_result.get("questions", []),
            "study_suggestions": mcq_result.get("study_suggestions", []),
            "references": mcq_result.get("references", []),
            "search_terms": mcq_result.get("search_terms", []),
        }

        return JSONResponse(content=response_payload, status_code=200)

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error generating MCQs: {str(e)}")

    finally:
        os.remove(temp_path)
@app.post("/generate_lesson_plan")
async def generate_lesson_plan_endpoint(
    # âœ… Sá»­ dá»¥ng Form thay cho Body Ä‘á»ƒ nháº­n multipart/form-data
    subject: str = Form(..., description="TÃªn mÃ´n há»c"),
    grade: str = Form(..., description="Lá»›p"),
    num_periods: int = Form(1, description="Sá»‘ tiáº¿t"),
    
    # âœ… Cho phÃ©p cáº£ hai dáº¡ng input lÃ  tÃ¹y chá»n
    text: Optional[str] = Form(None, description="Ná»™i dung bÃ i há»c dáº¡ng vÄƒn báº£n"),
    file: Optional[UploadFile] = File(None, description="File ná»™i dung bÃ i há»c (.pdf, .docx)")
):
    if not text and not file:
        raise HTTPException(status_code=400, detail="Báº¡n pháº£i cung cáº¥p ná»™i dung dáº¡ng text hoáº·c upload má»™t file.")

    temp_path = None
    try:
        lesson_content = ""
        if file:
            with tempfile.NamedTemporaryFile(delete=False, suffix=os.path.splitext(file.filename)[1]) as temp_file:
                temp_path = temp_file.name
                content = await file.read()
                temp_file.write(content)
            
            file_extension = os.path.splitext(file.filename)[1].lower()
            
            if file_extension == ".pdf":
                lesson_content = extract_text_from_pdf(temp_path)
            elif file_extension == ".docx":
                lesson_content = extract_text_from_docx(temp_path)
            else:
                 raise HTTPException(status_code=400, detail="Äá»‹nh dáº¡ng file khÃ´ng Ä‘Æ°á»£c há»— trá»£. Vui lÃ²ng táº£i lÃªn file PDF hoáº·c DOCX.")
            
            if not lesson_content or "KhÃ´ng thá»ƒ trÃ­ch xuáº¥t" in lesson_content or "TÃ i liá»‡u PDF bá»‹ lá»—i" in lesson_content:
                raise HTTPException(status_code=400, detail=lesson_content)
        
        elif text:
            lesson_content = text

        logger.info(f"Ná»™i dung bÃ i há»c Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ táº¡o giÃ¡o Ã¡n ({len(lesson_content)} kÃ½ tá»±).")
        
        result = generate_lesson_plan(lesson_content, subject, grade, num_periods)

        if "error" in result:
            raise HTTPException(status_code=500, detail=f"Lá»—i tá»« Gemini: {result.get('error')}")

        return JSONResponse(content=result, status_code=200)

    except HTTPException as http_exc:
        raise http_exc
    except Exception as e:
        logger.error(f"Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh khi táº¡o giÃ¡o Ã¡n: {e}", exc_info=True)
        return JSONResponse(
            content={
                "error": str(e),
                "trace": traceback.format_exc()
            },
            status_code=500
        )
    finally:

        if temp_path and os.path.exists(temp_path):
            os.remove(temp_path)
            logger.info(f"ÄÃ£ xÃ³a file táº¡m: {temp_path}")
# ----------------------------
# âŒ COMMENTED OUT - This endpoint is incomplete as its helper functions are not defined.
# ----------------------------
# @app.post("/analyze")
# async def analyze_document(file: UploadFile):
#     # The following functions are not defined in the script:
#     # extract_text, generate_summary, extract_concepts, assess_difficulty, suggest_topics
#     
#     # # Extract text
#     # text = await extract_text(file)
#     # 
#     # # Analyze document structure and content
#     # analysis = {
#     #     "summary": generate_summary(text),
#     #     "key_concepts": extract_concepts(text),
#     #     "difficulty_level": assess_difficulty(text),
#     #     "recommended_topics": suggest_topics(text)
#     # }
#     # 
#     # return JSONResponse(analysis)
#     raise HTTPException(status_code=501, detail="Endpoint not implemented.")

# --- Main Execution ---
def run_app():
    # nest_asyncio.apply() # May be needed in environments like Jupyter/Colab
    uvicorn.run(app, host="0.0.0.0", port=8004)

if __name__ == "__main__":
    run_app()